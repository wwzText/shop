(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/order-submit/order-submit"],{"06ff":function(t,e,i){"use strict";i.r(e);var r=i("9e97"),o=i("c916");for(var a in o)"default"!==a&&function(t){i.d(e,t,(function(){return o[t]}))}(a);i("660d");var n,s=i("f0c5"),c=Object(s["a"])(o["default"],r["b"],r["c"],!1,null,"562cfe56",null,!1,r["a"],n);e["default"]=c.exports},"660d":function(t,e,i){"use strict";var r=i("cb68"),o=i.n(r);o.a},"7f4f":function(t,e,i){"use strict";(function(t){i("aaea");r(i("66fd"));var e=r(i("06ff"));function r(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,i("543d")["createPage"])},"9e97":function(t,e,i){"use strict";var r;i.d(e,"b",(function(){return o})),i.d(e,"c",(function(){return a})),i.d(e,"a",(function(){return r}));var o=function(){var t=this,e=t.$createElement,i=(t._self._c,t.previewData?t.__map(t.previewData.mch_list,(function(e,i){var r=t.__get_orig(e),o=(e.coupon&&e.coupon.enabled||e.member_discount>0||e.member_discount<0||e.integral&&e.integral.can_use||e.temp_vip_discount||e.insert_rows&&e.insert_rows.length||e.full_reduce_discount>0||e.full_reduce_discount<0)&&e.coupon&&e.coupon.enabled&&!e.coupon.use?t.noCouponStatus(i):null;return{$orig:r,m0:o}})):null);t.$mp.data=Object.assign({},{$root:{l0:i}})},a=[]},c916:function(t,e,i){"use strict";i.r(e);var r=i("fa34"),o=i.n(r);for(var a in r)"default"!==a&&function(t){i.d(e,t,(function(){return r[t]}))}(a);e["default"]=o.a},cb68:function(t,e,i){},fa34:function(t,e,i){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var r=i("2f62");function o(t,e){var i;if("undefined"===typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(i=a(t))||e&&t&&"number"===typeof t.length){i&&(t=i);var r=0,o=function(){};return{s:o,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,s=!0,c=!1;return{s:function(){i=t[Symbol.iterator]()},n:function(){var t=i.next();return s=t.done,t},e:function(t){c=!0,n=t},f:function(){try{s||null==i.return||i.return()}finally{if(c)throw n}}}}function a(t,e){if(t){if("string"===typeof t)return n(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?n(t,e):void 0}}function n(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,r=new Array(e);i<e;i++)r[i]=t[i];return r}function s(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,r)}return i}function c(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?s(Object(i),!0).forEach((function(e){u(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):s(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function u(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var l=function(){i.e("components/page-component/app-diy-form/app-diy-form").then(function(){return resolve(i("f5ff"))}.bind(null,i)).catch(i.oe)},d=function(){i.e("pages/order-submit/app-submit-goods").then(function(){return resolve(i("489d"))}.bind(null,i)).catch(i.oe)},h=function(){i.e("pages/order-submit/app-coupon-pick").then(function(){return resolve(i("afb6"))}.bind(null,i)).catch(i.oe)},m=function(){i.e("pages/order-submit/app-bottom-modal").then(function(){return resolve(i("5500"))}.bind(null,i)).catch(i.oe)},p=function(){i.e("pages/order-submit/app-address-bar").then(function(){return resolve(i("0746"))}.bind(null,i)).catch(i.oe)},f=function(){i.e("pages/order-submit/app-submit-checkbox").then(function(){return resolve(i("3653"))}.bind(null,i)).catch(i.oe)},v=function(){i.e("components/basic-component/app-close/app-close").then(function(){return resolve(i("d6b7"))}.bind(null,i)).catch(i.oe)},_={name:"order-submit",components:{AppSubmitCheckbox:f,AppAddressBar:p,AppBottomModal:m,AppCouponPick:h,AppDiyForm:l,appSubmitGoods:d,AppClose:v},data:function(){return{totalTitle:"合计",check:!1,previewData:{mch_list:[],total_price:0,vip_card_discount_total_price:null,custom_currency_all:[]},getLocationFail:!1,previewUrl:null,submitUrl:null,plugin:null,orderPageUrl:null,submitLock:!1,getPayDataTimer:null,userTheme:null,payDataUrl:null,showPayResult:!0,payCancelUrl:null,loadingPreviewData:!0,showClose:!1,is_open:!1,mchList:""}},computed:c(c(c({},(0,r.mapState)({appImg:function(t){return t.mallConfig.__wxapp_img}})),{},{theme:function(){return this.userTheme?this.userTheme:this.getTheme}},(0,r.mapGetters)("mallConfig",{getTheme:"getTheme"})),{},{themeBgClass:function(){return this.theme.indexOf("gift")>=0?"".concat(this.theme," ").concat(this.theme,"-background"):"".concat(this.theme," ").concat(this.theme,"-m-back")},themeTextClass:function(){return this.theme.indexOf("gift")>=0?"".concat(this.theme," ").concat(this.theme,"-color"):"".concat(this.theme," ").concat(this.theme,"-m-text")}}),onLoad:function(t){var e,i=this,r=JSON.parse(t.mch_list),a=[],n=o(r);try{for(n.s();!(e=n.n()).done;){var s=e.value;s.mch_id>0&&a.push(s.mch_id)}}catch(c){n.e(c)}finally{n.f()}this.mchList=JSON.stringify(a),this.submitLock||(this.setFormData(t),this.$event.on(this.$const.EVENT_USER_LOGIN).then((function(){i.loadPreviewData()})))},onShow:function(){var t=this;this.showClose=!1,setTimeout((function(){t.showClose=!0}))},onUnload:function(){this.getPayDataTimer&&clearTimeout(this.getPayDataTimer)},watch:{"previewData.address.name":{handler:function(){this.changeZitiAddress()}},"previewData.address.mobile":{handler:function(){this.changeZitiAddress()}}},methods:{getMall:function(t){if(this.is_open=1==t.is_open,this.is_open){if(this.submitLock)return;this.loadPreviewData()}},noCouponStatus:function(t){var e=this.$store.getters["orderSubmit/getMchNoCouponStatusList"];return!!e[t]},navigateVipCardPrivilege:function(){t.navigateTo({url:"/plugins/vip_card/rights/rights?id=1"})},showCouponPicker:function(t){this.previewData.mch_list[t].showCouponPicker=!0},reversalShowInsertRows:function(t){this.previewData.mch_list[t].showInsertRows=!this.previewData.mch_list[t].showInsertRows},updateList:function(t,e){this.previewData.mch_list[e]=t,this.$forceUpdate()},setParams:function(t){t.total_title&&(this.totalTitle=t.total_title)},handleOrderFormInput:function(t,e){var i=[];for(var r in t)i[r]={key:t[r].key,label:t[r].name,value:t[r].value,required:t[r].is_required};var o=this.$store.state.orderSubmit.formData;o.list[e].order_form=i,this.$store.commit("orderSubmit/mutSetFormData",o)},handleOrderFormValidate:function(t,e){var i=this.$store.state.orderSubmit.formData;i.list[e].order_form_validate_result=t,this.$store.commit("orderSubmit/mutSetFormData",i)},setFormData:function(t){this.previewUrl=decodeURIComponent(t.preview_url||this.$api.order.preview),this.submitUrl=decodeURIComponent(t.submit_url||this.$api.order.submit),this.plugin=t.plugin||null,this.orderPageUrl=decodeURIComponent(t.order_page_url||"/pages/order/index/index?status=0"),this.userTheme=t.theme||null,this.payDataUrl=decodeURIComponent(t.pay_data_url||this.$api.order.pay_data),this.payCancelUrl=t.pay_cancel_url?decodeURIComponent(t.pay_cancel_url):null,this.showPayResult=t.show_pay_result||!0,"true"===this.showPayResult&&(this.showPayResult=!0),"false"===this.showPayResult&&(this.showPayResult=!1);var e=JSON.parse(t.mch_list);for(var i in e)if(0===parseInt(e[i].mch_id)){var r=e[i];e.splice(i,1),e.unshift(r);break}for(var o in e)for(var a in e[o].distance=0,e[o].remark="",e[o].order_form=[],e[o].use_integral=0,e[o].user_coupon_id=0,e[o].goods_list)e[o].goods_list[a].cart_id=e[o].goods_list[a].cart_id||0;this.$store.commit("orderSubmit/mutSetFormData",{list:e,address_id:0})},loadPreviewData:function(){var e=this;this.loadingPreviewData=!0,t.showLoading({mask:!0,title:"加载中"}),this.$request({url:this.previewUrl,method:"post",data:{form_data:JSON.stringify(this.$store.state.orderSubmit.formData)}}).then((function(i){if(e.loadingPreviewData=!1,t.hideLoading(),0===i.code){for(var r in i.data.allZiti&&!i.data.address&&(i.data.address={name:"",mobile:""}),i.data.mch_list)i.data.mch_list[r].showCouponPicker=!1,i.data.mch_list[r].noCoupons=!1,i.data.mch_list[r].showInsertRows=!1;e.previewData=i.data,e.setDiyFormScrollStatus(),e.checkCouponError(),e.updateStoreDistance(),e.updateGoodsCount()}else t.showModal({title:"提示",content:i.msg,showCancel:!1,success:function(){t.navigateBack()}})})).catch((function(){e.loadingPreviewData=!1,t.hideLoading()}))},navigateStore:function(e){if(0==this.previewData.mch_list[e].mch.id){var i="";"booking"===this.plugin&&(i=this.previewData.mch_list[0].goods_list[0].id);var r=this.plugin||"";t.navigateTo({url:"/pages/order-submit/store-pick?mchIndex=".concat(e,"&plugin=").concat(r,"&firstGoodsId=").concat(i)})}},navigateCoupon:function(e){t.navigateTo({url:"/pages/order-submit/coupon-pick?mchIndex=".concat(e)})},navigateSvip:function(e){t.navigateTo({url:"/pages/order-submit/vip-card?mchIndex=".concat(e)})},changeZitiAddress:function(){var t=this.$store.state.orderSubmit.formData;t.address={name:this.previewData.address?this.previewData.address.name:"",mobile:this.previewData.address?this.previewData.address.mobile:""},this.$store.commit("orderSubmit/mutSetFormData",t)},changeSendType:function(t,e){if(this.previewData.mch_list[t].delivery.send_type!=e){var i=this.$store.state.orderSubmit.formData;i.list[t].send_type=e,this.$store.commit("orderSubmit/mutSetFormData",i),this.previewData.mch_list[t].delivery.send_type=e,this.loadPreviewData()}},updateStoreDistance:function(){var e=this;this.previewData&&(this.previewData.has_ziti||"booking"==this.plugin)&&t.getLocation({success:function(t){for(var i in e.previewData.mch_list)if(e.previewData.mch_list[i].store&&(!e.previewData.mch_list[i].store.distance||"-m"==e.previewData.mch_list[i].store.distance)&&""!=e.previewData.mch_list[i].store.latitude&&""!=e.previewData.mch_list[i].store.longitude&&!isNaN(e.previewData.mch_list[i].store.latitude)&&!isNaN(e.previewData.mch_list[i].store.longitude)){var r=e.$utils.earthDistance({lat:t.latitude,lng:t.longitude},{lat:e.previewData.mch_list[i].store.latitude,lng:e.previewData.mch_list[i].store.longitude}),o="-m";o=r>1e3?(r/1e3).toFixed(2)+"km":r.toFixed(0)+"m",e.previewData.mch_list[i].store.distance=o}},fail:function(){e.getLocationFail=!0}})},openLocationSetting:function(){this.getLocationFail=!1,t.openSetting({})},showIntegralTip:function(){t.showModal({title:"积分抵扣说明",content:this.$store.state.mallConfig.mall.setting.member_integral_rule,showCancel:!1})},changeIntegral:function(t){var e=this.$store.state.orderSubmit.formData,i=!this.previewData.mch_list[t].integral.use;e.list[t].use_integral=i?1:0,this.previewData.mch_list[t].integral.use=i,this.loadPreviewData()},inputRemark:function(t){var e=this.$store.state.orderSubmit.formData;e.list[t].remark=this.previewData.mch_list[t].remark,this.$store.commit("orderSubmit/mutSetFormData",e)},submit:function(){var e=this;t.showLoading({mask:!0,title:"提交中"}),this.$request({url:this.submitUrl,method:"post",data:{form_data:JSON.stringify(this.$store.state.orderSubmit.formData)}}).then((function(i){0===i.code?e.getPayOrderId(i.data.queue_id,i.data.token):(e.submitLock=!1,t.hideLoading(),t.showModal({title:"提示",content:i.msg,showCancel:!1}))})).catch((function(i){e.submitLock=!1,t.hideLoading(),t.showModal({title:"提示",content:i.errMsg,showCancel:!1})}))},getPayOrderId:function(e,i){var r=this;this.$request({url:this.payDataUrl,method:"post",data:{queue_id:e,token:i}}).then((function(o){0===o.code?o.data.retry&&1===o.data.retry?r.getPayDataTimer=setTimeout((function(){r.getPayOrderId(e,i)}),1e3):(t.hideLoading(),r.pay(o.data)):(r.submitLock=!1,t.hideLoading(),t.showModal({title:"提示",content:o.msg,showCancel:!1}))})).catch((function(e){r.submitLock=!1,t.hideLoading(),t.showModal({title:"提示",content:e.errMsg,showCancel:!1})}))},pay:function(e){var i=this;this.$payment.pay(e.id).then((function(r){if(i.showPayResult)t.redirectTo({url:"/pages/order-submit/pay-result?payment_order_union_id=".concat(e.id,"&order_page_url=").concat(encodeURIComponent(i.orderPageUrl))});else{var o=i.orderPageUrl;-1===o.indexOf("?")?o+="?":o+="&",delete e.id,o+="pay_data=".concat(JSON.stringify(e)),t.redirectTo({url:o})}})).catch((function(r){if(i.payCancelUrl){var o=i.payCancelUrl;-1===o.indexOf("?")?o+="?":o+="&",o+="pay_data=".concat(JSON.stringify(e)),t.redirectTo({url:o})}else t.showModal({title:"提交失败",content:r.errMsg,showCancel:!1,success:function(){t.redirectTo({url:i.orderPageUrl})}})}))},jump:function(e){t.navigateTo({url:"/pages/order-submit/map"})},checkCouponError:function(){for(var e in this.previewData.mch_list)if(this.previewData.mch_list[e].coupon&&this.previewData.mch_list[e].coupon.coupon_error)return void t.showModal({title:"",content:this.previewData.mch_list[e].coupon.coupon_error,showCancel:!1})},setDiyFormScrollStatus:function(){for(var t in this.previewData.mch_list)this.previewData.mch_list[t].order_form&&(this.previewData.mch_list[t].order_form.value&&this.previewData.mch_list[t].order_form.value.length&&this.previewData.mch_list[t].order_form.value.length>=5?this.previewData.mch_list[t].order_form.show_scroll=!0:this.previewData.mch_list[t].order_form.show_scroll=!1)},subscribe:function(){var e=this;for(var i in this.$store.state.orderSubmit.formData.list){var r=this.$store.state.orderSubmit.formData.list[i];if(r.order_form_validate_result&&r.order_form_validate_result.hasError)return void t.showModal({title:"提示",content:r.order_form_validate_result.errors[0].msg,showCancel:!1})}for(var o in this.$store.state.orderSubmit.formData.list)for(var a in this.$store.state.orderSubmit.formData.list[o].goods_list){var n=this.$store.state.orderSubmit.formData.list[o].goods_list[a];if(n.goods_form_validate_result&&n.goods_form_validate_result.hasError)return void t.showModal({title:"提示",content:n.goods_form_validate_result.errors[0].msg,showCancel:!1})}this.submitLock||(this.submitLock=!0,this.$subscribe(this.previewData.template_message_list).then((function(t){e.submit()})).catch((function(t){e.submit()})))},handleGoodsFormInput:function(t,e){var i=e.split(","),r=parseInt(i[0]),o=parseInt(i[1]),a=(parseInt(i[2]),[]);for(var n in t)a[n]={key:t[n].key,label:t[n].name,value:t[n].value,required:t[n].is_required};var s=this.$store.state.orderSubmit.formData;s.list[r].goods_list[o].form_data=a,this.$store.commit("orderSubmit/mutSetFormData",s)},handleGoodsFormValidate:function(t,e){var i=e.split(","),r=parseInt(i[0]),o=parseInt(i[1]),a=this.$store.state.orderSubmit.formData;a.list[r].goods_list[o].goods_form_validate_result=t,this.$store.commit("orderSubmit/mutSetFormData",a)},updateGoodsCount:function(){for(var t in this.previewData.mch_list){var e=0;for(var i in this.previewData.mch_list[t].goods_list)e+=parseInt(this.previewData.mch_list[t].goods_list[i].num);this.previewData.mch_list[t].goods_count=e}},handleAddressInput:function(t){"undefined"!==typeof t.name&&(this.previewData.address.name=t.name),"undefined"!==typeof t.mobile&&(this.previewData.address.mobile=t.mobile)}}};e.default=_}).call(this,i("543d")["default"])}},[["7f4f","common/runtime","common/vendor"]]]);