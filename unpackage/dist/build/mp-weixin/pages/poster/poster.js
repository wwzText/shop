(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/poster/poster"],{"040d":function(e,t,n){},21483:function(e,t,n){"use strict";var r=n("040d"),o=n.n(r);o.a},"295f":function(e,t,n){"use strict";n.r(t);var r=n("eb81"),o=n.n(r);for(var a in r)"default"!==a&&function(e){n.d(t,e,(function(){return r[e]}))}(a);t["default"]=o.a},"33b4":function(e,t,n){"use strict";var r;n.d(t,"b",(function(){return o})),n.d(t,"c",(function(){return a})),n.d(t,"a",(function(){return r}));var o=function(){var e=this,t=e.$createElement;e._self._c},a=[]},"5a12":function(e,t,n){"use strict";(function(e){n("aaea");r(n("66fd"));var t=r(n("d64b7"));function r(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,n("543d")["createPage"])},d64b7:function(e,t,n){"use strict";n.r(t);var r=n("33b4"),o=n("295f");for(var a in o)"default"!==a&&function(e){n.d(t,e,(function(){return o[e]}))}(a);n("21483");var i,c=n("f0c5"),s=Object(c["a"])(o["default"],r["b"],r["c"],!1,null,"35ff7da1",null,!1,r["a"],i);t["default"]=s.exports},eb81:function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=a(n("a34a")),o=n("2f62");function a(e){return e&&e.__esModule?e:{default:e}}function i(e,t,n,r,o,a,i){try{var c=e[a](i),s=c.value}catch(u){return void n(u)}c.done?t(s):Promise.resolve(s).then(r,o)}function c(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function c(e){i(a,r,o,c,s,"next",e)}function s(e){i(a,r,o,c,s,"throw",e)}c(void 0)}))}}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){f(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var d={data:function(){return{card_id:0,coupon_id:0,rpx:1,show:!1,info:{},canvas:null,dpr:2}},computed:u(u({},(0,o.mapGetters)("mallConfig",{getTheme:"getTheme"})),(0,o.mapState)({poster_img:function(e){return e.mallConfig.__wxapp_img.poster}})),methods:{imgLoad:function(e){return new Promise((function(t,n){e.onload=function(){t(e)},e.onerror=function(){n(2)}}))},createdImg:function(e,t,n,o,a,i,s,u){var f=arguments,d=this;return c(r.default.mark((function c(){var l,p;return r.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:return l=f.length>8&&void 0!==f[8]&&f[8],p=e.createImage(),p.src=n,r.next=5,d.imgLoad(p).then((function(e){t.beginPath(),l&&(t.arc(i/2+o,s/2+a,i/2,0,2*Math.PI,!1),t.strokeStyle=u,t.stroke(),t.clip()),t.drawImage(p,o,a,i,s),t.restore(),t.closePath(),t.save()}));case 5:case"end":return r.stop()}}),c)})))()},createdText:function(e,t,n,r,o,a,i,c){t.beginPath(),t.textAlign=i,t.font=a,t.fillStyle=c,t.fillText(n,r,o),t.stroke(),t.closePath(),t.save()},createdEllipse:function(e,t,n,r,o,a,i){var c=a/2,s=Math.abs(o-a);t.beginPath(),t.moveTo(n+c,r),t.lineTo(n+c+s,r),t.arcTo(n+o,r,n+o,r+c,c),t.arcTo(n+o,r+a,n+c+s,r+a,c),t.lineTo(n+c,r+a),t.arcTo(n,r+a,n,r+c,c),t.arcTo(n,r,n+c,r,c),t.strokeStyle="rgba(0, 0, 0, 0)",t.stroke(),t.clip(),t.fillStyle=i,t.fill(),t.restore(),t.closePath(),t.save()},created:function(e,t,n){var o=this;return c(r.default.mark((function a(){var i,c,s,u,f,d,l,p,h,g;return r.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:return i="#353535",c="sans-serif",r.next=4,o.createdImg(e,t,o.info.poster_bg,0,0,750*n,1334*n,"white",!1);case 4:return r.next=6,o.createdImg(e,t,o.info.avatar,310*n,66*n,130*n,130*n,"white",!0);case 6:if(o.createdText(e,t,o.info.nickname,376*n,252*n,28*n+"px "+c,"center","white"),!(o.card_id>0)){r.next=15;break}return r.next=10,o.createdImg(e,t,o.info.pic_url,76*n,394*n,120*n,120*n,"white",!0);case 10:s=o.info.name,u=33*n+"px "+c,s.length>20?(o.createdText(e,t,s.substring(0,10),220*n,439*n,u,"left",i),o.createdText(e,t,s.substring(11,20)+"...",220*n,490*n,u,"left",i)):s.length>10?(o.createdText(e,t,s.substring(0,10),220*n,439*n,u,"left",i),o.createdText(e,t,s.substring(11,s.length),220*n,490*n,u,"left",i)):o.createdText(e,t,s,220*n,465*n,u,"left",i),r.next=27;break;case 15:1===o.info.type?(o.createdText(e,t,o.info.discount,100*n,470*n,58*n+"px "+c,"left","white"),o.createdText(e,t,"折",185*n,470*n,33*n+"px "+c,"left","white")):(f=129,d=(o.info.sub_price+"").length,d>1&&(f-=15*(d-1)),o.createdText(e,t,"￥",f*n,470*n,33*n+"px "+c,"left","white"),o.createdText(e,t,o.info.sub_price,(f+30)*n,470*n,58*n+"px "+c,"left","white")),l="无门槛使用",o.info.min_price>0&&(l="满"+o.info.min_price+"可用"),o.createdText(e,t,l,286*n,439*n,33*n+"px "+c,"left",i),o.createdText(e,t,o.info.appoint_type,286*n,490*n,28*n+"px "+c,"left",i),p="",p=1==o.info.expire_type?"有效期：领取后".concat(o.info.expire_day,"天内有效"):"有效期：".concat(o.info.begin_time,"-").concat(o.info.end_time),h=parseInt(24*n),t.font=h+"px "+c,g=t.measureText(p).width,o.createdEllipse(e,t,(750*n-g)/2-h,882*n,g+48*n,60*n,"rgba(0, 0, 0, 0.2)"),o.createdText(e,t,p,375*n,920*n,h+"px "+c,"center","white");case 27:return r.next=29,o.createdImg(e,t,o.info.qrcode,255*n,964*n,240*n,240*n,"white",!0);case 29:return t.draw(),r.abrupt("return",null);case 31:case"end":return r.stop()}}),a)})))()},submitSave:function(){var t=this;t.$showLoading({text:"正在保存图片"}),e.canvasToTempFilePath({canvas:t.canvas,success:function(n){e.getImageInfo({src:n.tempFilePath,success:function(n){e.saveImageToPhotosAlbum({filePath:n.path,success:function(){e.showToast({title:"保存成功"})},fail:function(t){t.errMsg&&e.showModal({title:"提示",content:"您好,请先授权保存到相册权限",showCancel:!1,success:function(t){t.confirm&&e.openSetting({success:function(t){t.authSetting["scope.writePhotosAlbum"]?e.saveImageToPhotosAlbum({filePath:n.path,success:function(){e.showToast({title:"保存成功"})}}):e.showModal({title:"提示",content:"授权失败，请稍后重新获取",showCancel:!1})}})}})},complete:function(e){t.$hideLoading()}})},fail:function(t){e.showModal({title:"图片下载失败",content:t.errMsg,showCancel:!1})},complete:function(e){t.$hideLoading()}})}})},getList:function(){var t,n,r=this;r.card_id>0&&(t=r.$api.poster.card,n={cardId:r.card_id}),r.coupon_id>0&&(t=r.$api.poster.coupon,n={coupon_id:r.coupon_id}),r.$request({url:t,data:n}).then((function(t){0==t.code?(r.info=t.data,r.$hideLoading(),setTimeout((function(){var t=e.createSelectorQuery();t.select("#poster").fields({node:!0,size:!0}).exec((function(t){var n=e.getSystemInfoSync().pixelRatio;r.canvas=t[0].node;var o=r.canvas.getContext("2d");r.canvas.width=t[0].width*n,r.canvas.height=t[0].height*n,o.scale(n,n),r.created(r.canvas,o,.4)}))}),100)):(r.$hideLoading(),e.showToast({title:t.msg,icon:"none",duration:1e3}))})).catch((function(e){r.$hideLoading()}))}},onLoad:function(t){var n=this;this.dpr=e.getSystemInfoSync().pixelRatio,t.card_id>0&&(n.card_id=t.card_id),t.coupon_id>0&&(n.coupon_id=t.coupon_id),e.getSystemInfo({success:function(e){n.rpx=e.windowWidth/375}}),n.$showLoading({text:"生成中"}),n.getList()}};t.default=d}).call(this,n("543d")["default"])}},[["5a12","common/runtime","common/vendor"]]]);