(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["plugins/vip_card/buy/buy"],{"0fa3":function(e,t,n){},"42b20":function(e,t,n){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=n("2f62");function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var c=function(){n.e("components/page-component/app-diy-form/app-diy-form").then(function(){return resolve(n("4e37"))}.bind(null,n)).catch(n.oe)},d=function(){n.e("components/basic-component/app-close/app-close").then(function(){return resolve(n("699f"))}.bind(null,n)).catch(n.oe)},s={data:function(){return{detail:{},list:{},card:{expire_day:""},today:"",end_day:"",total_coupon:0,total_card:0,id:0,end_time:"",start_day:"",success:!1,iphone_x:!1,template_message:[],loading:!1,validateResult:{hasError:!1},showClose:!1,is_open:!1}},components:{AppDiyForm:c,AppClose:d},computed:o({},(0,a.mapState)({svipImg:function(e){return e.mallConfig.__wxapp_img.vip_card}})),methods:{getMall:function(e){this.is_open=1==e.is_open,this.is_open&&this.subscribe()},toDetail:function(){e.navigateTo({url:"/plugins/vip_card/rights/rights?id="+this.id})},toBack:function(){this.success=!1,e.navigateBack()},toCoupon:function(){e.navigateTo({url:"/pages/coupon/index/index"})},toCard:function(){e.navigateTo({url:"/pages/card/index/index"})},toBalance:function(){e.navigateTo({url:"/pages/balance/balance"})},toIntegral:function(){e.navigateTo({url:"/plugins/integral_mall/index/index"})},getSetting:function(){var t=this;t.$showLoading({type:"global",text:"加载中..."}),t.$request({url:t.$api.vip_card.setting}).then((function(n){0==n.code?(t.list=n.data,e.setNavigationBarTitle({title:"购买"+t.list.name}),t.template_message=n.data.template_message,t.getCard()):e.showToast({title:n.msg,icon:"none",duration:1e3})})).catch((function(e){t.$hideLoading()}))},getCard:function(){var t=this;t.$request({url:t.$api.vip_card.card_detail,data:{id:this.id}}).then((function(n){if(t.$hideLoading(),0==n.code){t.card=n.data;var a=Date.parse(new Date);t.end_time>0&&(a=Date.parse(new Date(t.end_time)));var i=1e3*(a/1e3+86400*n.data.expire_day),o=new Date(i),r=o.getFullYear(),c=o.getMonth()+1;c>=1&&c<=9&&(c="0"+c);var d=o.getDate();d>=1&&d<=9&&(d="0"+d),t.end_day=r+"/"+c+"/"+d,t.card.coupons.forEach((function(e){t.total_coupon+=+e.send_num})),t.card.cards.forEach((function(e){t.total_card+=+e.send_num}))}else e.showToast({title:n.msg,icon:"none",duration:1e3})})).catch((function(e){t.$hideLoading()}))},subscribe:function(){var t=this;if(!this.validateResult.hasError)return!!this.is_open&&void this.$subscribe(this.template_message).then((function(e){t.toSubmit()})).catch((function(e){t.toSubmit()}));e.showToast({title:this.validateResult.errors[0].msg,icon:"none"})},toSubmit:function(){var t=this;if(this.loading)return!1;this.loading=!0,e.showLoading({title:"购买中..."}),t.$request({url:t.$api.vip_card.order_submit,data:{id:this.id,order_form:JSON.stringify(t.list.order_form)},method:"post"}).then((function(n){0===n.code?t.getPayOrderId(n.data.queue_id,n.data.token):(t.loading=!1,e.hideLoading(),e.showModal({title:"提示",content:n.msg,showCancel:!1}))})).catch((function(n){t.loading=!1,e.hideLoading(),e.showModal({title:"提示",content:n.errMsg,showCancel:!1})}))},handleOrderFormValidate:function(e){this.validateResult=e},handleGoodsFormInput:function(e,t){var n=[];for(var a in e)n[a]={key:e[a].key,label:e[a].name,value:e[a].value,required:e[a].is_required};this.list.order_form=n},getPayOrderId:function(t,n){var a=this;this.$request({url:this.$api.vip_card.pay_data,method:"post",data:{queue_id:t,token:n}}).then((function(i){0===i.code?i.data.retry&&1===i.data.retry?a.getPayDataTimer=setTimeout((function(){a.getPayOrderId(t,n)}),1e3):a.pay(i.data.id):(e.hideLoading(),a.loading=!1,e.showModal({title:"提示",content:i.msg,showCancel:!1}))})).catch((function(t){a.loading=!1,e.hideLoading(),e.showModal({title:"提示",content:t.errMsg,showCancel:!1})}))},pay:function(t){var n=this;n.$payment.pay(t).then((function(t){e.hideLoading(),n.loading=!1,e.showToast({title:"购买成功",duration:1e3}),n.card.send_integral_num>0||n.card.send_balance>0||n.card.coupons.length>0||n.card.cards.length>0?n.success=!0:setTimeout((function(t){e.navigateBack()}),1e3)})).catch((function(t){e.hideLoading(),n.loading=!1,e.showToast({title:"支付失败",icon:"none",duration:1e3})}))}},onUnload:function(){clearInterval(this.getPayDataTimer)},onLoad:function(t){var n=this;e.getSystemInfo({success:function(e){(e.model.indexOf("iPhone X")>-1||e.model.indexOf("iPhone 11")>-1||e.model.indexOf("iPhone11")>-1||e.model.indexOf("iPhone12")>-1)&&(n.iphone_x=!0)}});var a=new Date,i=a.getFullYear(),o=a.getMonth()+1;o>=1&&o<=9&&(o="0"+o);var r=a.getDate();r>=1&&r<=9&&(r="0"+r),this.today=i+"/"+o+"/"+r,this.id=t.id,this.end_time=t.end,this.expire_day=t.expire_day?t.expire_day:0,n.getSetting(t.id)}};t.default=s}).call(this,n("543d")["default"])},"6e51":function(e,t,n){"use strict";var a=n("0fa3"),i=n.n(a);i.a},9616:function(e,t,n){"use strict";n.r(t);var a=n("42b20"),i=n.n(a);for(var o in a)"default"!==o&&function(e){n.d(t,e,(function(){return a[e]}))}(o);t["default"]=i.a},a4ea:function(e,t,n){"use strict";n.r(t);var a=n("cced"),i=n("9616");for(var o in i)"default"!==o&&function(e){n.d(t,e,(function(){return i[e]}))}(o);n("6e51");var r,c=n("f0c5"),d=Object(c["a"])(i["default"],a["b"],a["c"],!1,null,"28ea5af9",null,!1,a["a"],r);t["default"]=d.exports},c34b:function(e,t,n){"use strict";(function(e){n("b8bc");a(n("66fd"));var t=a(n("a4ea"));function a(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,n("543d")["createPage"])},cced:function(e,t,n){"use strict";var a;n.d(t,"b",(function(){return i})),n.d(t,"c",(function(){return o})),n.d(t,"a",(function(){return a}));var i=function(){var e=this,t=e.$createElement;e._self._c;e._isMounted||(e.e0=function(t){e.showClose=!0})},o=[]}},[["c34b","common/runtime","common/vendor"]]]);